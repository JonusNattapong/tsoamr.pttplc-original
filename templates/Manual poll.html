<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ManualPoll</title>
  <!-- <link rel="stylesheet" href="style.css"> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Bootstrap Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">



  <!-- Latest compiled JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Bootstrap Datepicker Stylesheet and Script -->
  <!-- Option 1: Include in HTML -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome-free/css/all.min.css') }}">
   <!-- Custom fonts for this template-->
   <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
   <link
       href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
       rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
 
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome-free/css/all.min.css') }}">


  
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/sb-admin-2.css') }}">
</head>


<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper" >
  
        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar" >
  
            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
              <!-- <div class="sidebar-brand-icon rotate-n-15" >
                <img src="{{ url_for('static', filename='img/1200px-PTT-01.svg (1).png') }}" style="width: 40%;" alt="">
            </div> -->
                <div class="sidebar-brand-text mx-3" style="margin-top: 10px;">PTT<p style="font-size: xx-small;" >AUTOMATIC METER READING</p></div>
                
            </a>
  
            <!-- Divider -->
            <hr class="sidebar-divider my-0">
  
            <!-- Nav Item - Dashboard -->
            <!-- Nav Item - Dashboard -->
          <li class="nav-item active">
            <a class="nav-link" href="/">
              <i class="fas fa-fw fa-chart-area"></i>
                <span>Dashboard</span></a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Interface
        </div>

        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                aria-expanded="true" aria-controls="collapseTwo">
                <i class="fas fa-fw fa-table"></i>
                <span>Reports</span>
            </a>
            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">List Reports:</h6>
                    <a class="collapse-item" href="billing_data">View Billing Data</a>
                    <a class="collapse-item" href="#">View EVC Status</a>
                    <a class="collapse-item" href="DailySummary">Daily Summary</a>
                    <a class="collapse-item" href="#">Monthly Summary</a>
                    <a class="collapse-item" href="site_detail">Site Detail</a>
                </div>
            </div>
        </li>
        <hr class="sidebar-divider">
        <div class="sidebar-heading">
          Manage
      </div>
        <!-- Nav Item - Utilities Collapse Menu -->
        <li class="nav-item">
          <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
              aria-expanded="true" aria-controls="collapsePages">
              <i class="fas fa-user-cog"></i>


              <span>Manage Users</span>
          </a>
          <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
              <div class="bg-white py-2 collapse-inner rounded">
                <h6 class="collapse-header">List Manage Users:</h6>
                <a class="collapse-item" href="add_user">Add User</a>
                <a class="collapse-item" href="edit_user">Edit User</a>
                <a class="collapse-item" href="remove_user">Remove User</a>
                <a class="collapse-item" href="user_history">User History</a>
              </div>
          </div>
      </li>
        
        <li class="nav-item">
          <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
              aria-expanded="true" aria-controls="collapseUtilities">
              <i class="fas fa-sitemap"></i>




              <span>Manage Sites</span>
          </a>
          <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
              data-parent="#accordionSidebar">
              <div class="bg-white py-2 collapse-inner rounded">
                  <h6 class="collapse-header">List Manage Site:</h6>
                  <a class="collapse-item" href="add_site">Add Site</a>
                  <a class="collapse-item" href="edit_site">Edit Site</a>
                  <a class="collapse-item" href="remove_site">Remove Site</a>
                  
              </div>
          </div>
      </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Polling
        </div>

        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
          <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePolling"
              aria-expanded="true" aria-controls="collapsePolling">
              <i class="fas fa-cogs"></i>



              <span>Polling Setting</span>
          </a>
          <div id="collapsePolling" class="collapse" aria-labelledby="headingPolling"
              data-parent="#accordionSidebar">
              <div class="bg-white py-2 collapse-inner rounded">
                  <h6 class="collapse-header">List Polling Setting:</h6>
                  <a class="collapse-item" href="evc_management">EVC Management</a>
                  <a class="collapse-item" href="polling_route">Polling Range Setting</a>
                  <a class="collapse-item" href="polling_hourly">Polling Range Hourly</a>
                  <a class="collapse-item" href="mapping_config">Configuration Mapping</a>
                  <a class="collapse-item" href="mapping_billing">Daily Billing Mapping</a>
                  <a class="collapse-item" href="mapping_hourly">Hourly Billing Mapping</a>
                  
              </div>
          </div>
      </li>
      <li class="nav-item">
        <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseActions"
            aria-expanded="true" aria-controls="collapseActions">
            <i class="fas fa-fw fa-wrench"></i>
            <span>Polling Actions</span>
        </a>
        <div id="collapseActions" class="collapse" aria-labelledby="headingActions"
            data-parent="#accordionSidebar">
            <div class="bg-white py-2 collapse-inner rounded">
                <h6 class="collapse-header">List Polling Actions:</h6>
                <a class="collapse-item" href="Manualpoll_data">Manual Poll (EVC Profile)</a>
                <a class="collapse-item" href="write_evc">Write Config (SG,CO2,N2)</a>
               
                
            </div>
        </div>
    </li>
           
    <hr class="sidebar-divider">
    <div class="sidebar-heading">
      Prediction
  </div>

  <!-- Nav Item - Pages Collapse Menu -->
  <li class="nav-item">
    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseai"
        aria-expanded="true" aria-controls="collapseai">
        <i class="fas fa-robot"></i>
<span>AI Prediction</span>

    </a>
    <div id="collapseai" class="collapse" aria-labelledby="headingai"
        data-parent="#accordionSidebar">
        <div class="bg-white py-2 collapse-inner rounded">
            <h6 class="collapse-header">List AI Prediction:</h6>
            
            <a class="collapse-item" href="Numeric_Prediction">Numeric Prediction</a>
           
            
        </div>
    </div>
</li>     
          <!-- Nav Item - Tables -->
          
              <!-- Divider -->
              <hr class="sidebar-divider d-none d-md-block">
  
              <!-- Sidebar Toggler (Sidebar) -->
              <div class="text-center d-none d-md-inline">
                  <button class="rounded-circle border-0" id="sidebarToggle"></button>
              </div>
  
          </ul>
          <!-- End of Sidebar -->
<!-- Content Wrapper -->
<div id="content-wrapper" class="d-flex flex-column">

    <!-- Main Content -->
    <div id="content">

        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

            <!-- Sidebar Toggle (Topbar) -->
            <form class="form-inline">
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>
            </form>

            <!-- Topbar Search -->
            <form
            class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
            <div class="input-group">                    
                <div class="input-group-append" style="padding: 0px 20px; display: inline-block; width: 40%;border-radius: 15px;margin-left: -40px;">
                  <img src="https://www.pttplc.com/uploads/About/logo_PTT_3.png" style="width: 100%;display: block;height: auto" alt="">
                </div>
            </div>
        </form>

            <!-- Topbar Navbar -->
            <ul class="navbar-nav ml-auto">

                <!-- Nav Item - Search Dropdown (Visible Only XS) -->
                <li class="nav-item dropdown no-arrow d-sm-none">
                    <a class="nav-link dropdown-toggle" href="#" id="searchDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-search fa-fw"></i>
                    </a>
                    <!-- Dropdown - Messages -->
                    <div class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in"
                        aria-labelledby="searchDropdown">
                        <form class="form-inline mr-auto w-100 navbar-search">
                            <div class="input-group">
                                <input type="text" class="form-control bg-light border-0 small"
                                    placeholder="Search for..." aria-label="Search"
                                    aria-describedby="basic-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-primary" type="button">
                                        <i class="fas fa-search fa-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </li>

               
                

                <div class="topbar-divider d-none d-sm-block"></div>

                <!-- Nav Item - User Information -->
                <li class="nav-item dropdown no-arrow">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                              data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              <span class="mr-2 d-none d-lg-inline text-gray-600 small">{{username}}</span>
                              <i class="fa-solid fa-user fa-lg" style="color: #e5e9f6;"></i>
                          </a>
                    <!-- Dropdown - User Information -->
                    <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                        aria-labelledby="userDropdown">
                        <a class="dropdown-item" href="#">
                            <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                            Profile
                        </a>
                        <a class="dropdown-item" href="#">
                            <i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i>
                            Settings
                        </a>
                        <a class="dropdown-item" href="#">
                            <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                            Activity Log
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="logout" >
                            <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                            Logout
                        </a>
                    </div>
                </li>

            </ul>

        </nav>
        <!-- End of Topbar -->
   
        <div class="container-fluid">

          <!-- Page Heading -->
          
  
          <div class="card shadow mb-4" style="width: 100%;">
          <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">ManualPoll</h6>
             
      </div> 
<div class="row">
<div class="col-md-12">
<div class="form-group">
<div class="box_we">

    <div class="container-menu">
                  
      <form id="filterForm" action="{{ url_for('Manualpoll_data') }}" method="get"  class="form-container" style="padding: 40px;">
        <div class="row"  style="justify-content: center;">
            <div class="col-md-4">
              <label  for="region_dropdown">Region:</label>
              <select name="region_dropdown" id="region_dropdown"  class="form-control" required>
                  <option value="{{ selected_region }}" style="color: gray;"> select.... </option>
                  {% for region_option in region_options %}
                      <option value="{{ region_option }}" {% if region_option == selected_region %}selected{% endif %}>{{ region_option }}</option>
                  {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label  for="tag_dropdown">Site:</label>
              <select name="tag_dropdown" id="tag_dropdown"  class="form-control" required>
                <option value="{{ selected_tag }}" selected>--selected_tag--</option>
                {% for tag in tag_options %}
                <option value="{{ tag }}" {% if selected_tag==tag %}selected{% endif %}>{{ tag }}</option>
                {% endfor %}
              </select>
            </div>
        
        <div class="col-md-4">
            <label  for="display_dropdown">Poll Type:</label>
            <select name="display_dropdown" id="display_dropdown"  class="form-control" required>
                <option value="{{poll_type}}" style="color: gray;">{{test_poll_type}} </option>
                <option value="1" style="color: gray;"> Daily </option>
                <option value="2" style="color: gray;"> Hourly </option>
            
            </select>
          </div>
      
    </div>
        <br>
        <div class="button-container d-flex justify-content-center" >
              <input class="btn btn-primary" type="submit" class="DB" value="Submit ">
            </div>
        </div>
    </div>



 
        {% if not df.empty %}
        <div class="card-body d-flex justify-content-center align-items-center">
            <div class="table-responsive" style="font-size: x-small; width:90%;">
                <table border="1" class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead style="background-color:rgb(248, 251, 253)">
                        <tr style="color:#212529">
                            <th ></th>
                            {% for title in titles %}
                            <th>{{ title }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for index, row in df.iterrows() %}
                        <tr>
                            <td>    
                                <input type="radio" name="selected_row_radio" value="{{ index + 1 }}" onchange="updateSelectedRow(this.value);">
                                
                            </td>
                            {% for col in titles %}
                            <td>{{ row[col] }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </form>
                        <div class="container-fluid " >
                            
                        <div class="button-container d-flex justify-content-center align-items-center" style="margin-left: 100px;" >
                            <form method="POST" class="form-container" action="/save_to_oracle_manualpoll" id="myForm">
                            <button class="btn btn-primary   mx-2" style="display: none;  " id="fetchDataButton" >SAVEDATABASE</button>
                            </form>
                            
                            <form method="POST" class="form-container" action="/pingdata" id="myForm">
                                <button class="btn btn-danger  mx-2"  style="display: none; " id="pingData">PING</button>
                            </form>
                            <div id="loading" style="display:none;">
                                <i class="fas fa-sync-alt refresh-icon"></i>
                            </div>
                            
                            
                        </div>
                            
                            <form method="POST" class="form-container" action="/read_data" id="myForm">           
                                {% if not df.empty %}

                                <div class="button-container d-flex justify-content-center align-items-center" style="margin-top:-38px; margin-left: -260px;">
                                    <button class="btn btn-success mx-2" id="popupButton" type="submit" onclick="showAndWrite()">Poll Data</button>
                                </div>
                                <div class="form-group" style="display: none;">
                                    <label for="selected_row" style="margin-bottom: 100px;">selected_row</label>
                                    <input type="number" class="form-control" id="selected_row" name="selected_row" value="" required style="height: 30px; width: 100%; font-size: x-small; margin-top: -100px; border-radius: 0.5rem; border: none; padding-left: 10px;">
                                </div>
                                
                            </div>
                            

                            <div class="card-body d-flex justify-content-center align-items-center" >
                                
                                <div class="table-responsive" style="font-size: x-small;">
                                    
                                    <hr class="sidebar-divider d-none d-md-block">
                                    <div class="box_we" >
                                        <div class="selected"style="display: flex; margin:0 5px;">
                                         
                                          <p>Region: <span id="selected_region">{{ selected_region }}</span></p>
                                          <p>/ Site: <span id="selected_tag">{{ selected_tag }}</span></p>
                                          <p>/ Run: <span id="selected_date">{{ run }}</span></p>
                                          
                                        </div>
                                      </div>
                                    {{ result_config_html | safe }}
                                    
                                </table>
                            </div>
                        </div>
                               
                        <div class="card-body d-flex justify-content-center align-items-center">
                            <div class="table-responsive" style="font-size: x-small;">
                                
                                {{ result_billing_html | safe }}
                            </div>
                        </div>
                        
                        
                        {% endif %}
                                        
                     
                     </form>
                     
               <div id="billing-data-container"></div>
                   
                 </div>
                 
             </div>
         </div>

         <!-- partial -->
         

        
     </div>
     
 </div>


</form>


<!-- <button onclick="openPopup()">Open Popup</button> -->
</body>

<!-- สคริปต์สำหรับ updateSelectedRow --> 
 <script>
    function updateSelectedRow(value) { 
        document.getElementById('selected_row').value = value; 
        localStorage.setItem('selected_row', value); 
    } 
    // เมื่อโหลดหน้าเว็บ ให้กำหนดค่าจาก Local Storage ถ้ามีค่าเก็บอยู่ 
    window.onload = function() { 
        var selectedValue = localStorage.getItem('selected_row'); 
        if (selectedValue) { 
            document.getElementById('selected_row').value = selectedValue; 
            var selectedRadio = document.querySelector(`input[name="selected_row_radio"][value="${selectedValue}"]`); 
            if (selectedRadio) { selectedRadio.checked = true;
            } 
        }
    }

<script>
    $(document).ready(function() {
        // Make an AJAX request to the /read_data endpoint
        $.post("/read_data", function(data) {
            // Insert the HTML into the container
            $("#billing-data-container").html(data.html);
        });
    });
</script>
<script>
    function updateSelectedRow(value) {
        document.getElementById('selected_row').value = value;
    }
    
    </script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
      // Check if df is not empty
      {% if not df.empty %}
        // Show the buttons
        document.getElementById('fetchDataButton').style.display = 'inline-block';
        document.getElementById('pingData').style.display = 'inline-block';
      {% endif %}
    });
  </script>
  

  <script>
    function showAndWrite() {
        const popup = window.open("", "popup", "width=600,height=600,magin-top=100px");
        popup.document.write("<html><head><title>Analys Polling</title></head><body>");
        popup.document.write("<h1>POPUP EVC!</h1>");
        popup.document.write("<div id='popup-content'>Loading...</div>");
        popup.document.write("</body></html>");
  
        // Ensure the clear_data endpoint is called when the popup is closed
        window.addEventListener('beforeunload', function() {
            fetch('/clear_data', { method: 'POST' });
        });
  
        popup.addEventListener('beforeunload', function() {
            fetch('/clear_data', { method: 'POST' });
        });
  
        function refreshPopup() {
            fetch('/get_file')
                .then(response => response.json())
                .then(data => {
                    if (data.data !== "File not found") {
                        let content = data.data;
                        
                        // Check if the text contains 'Polling successfully' and 'Finish Polling Config' and style them in green
                        content = content.replace(/Polling successfully/g, 
                                  "<span style='color: green;'>Polling successfully</span>");
                        
                        content = content.replace(/Finish Polling Config/g, 
                                  "<span style='color: green;'>Finish Polling Config</span>");
                        
                        // Display the modified content
                        popup.document.getElementById('popup-content').innerHTML = content.replace(/\n/g, '<br>');
                    } else {
                        popup.document.getElementById('popup-content').innerText = "File not found";
                    }
                })
                .catch(error => console.error('Error fetching file:', error));
            
            // Stop refreshing if the popup is closed
            if (popup.closed) {
                clearInterval(intervalId);
                fetch('/clear_data', { method: 'POST' });
            }
        }
  
        function writeNumber() {
            fetch('/read_data', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                    // Continue refreshing, no need to stop the interval
                })
                .catch(error => console.error('Error:', error));
        }
        const intervalId = setInterval(refreshPopup,0); // Refresh every second
        writeNumber();
    }
</script>
  
  <script>
    
    $(document).ready(function () {
        // Event listener for region dropdown change
        $('#region_dropdown').change(function () {
            console.log('Region dropdown changed');
            var selectedRegion = $(this).val();
  
            $.ajax({
                type: 'GET',
                url: '/get_tags',
                data: { 'selected_region': selectedRegion },
                success: function (response) {
                    console.log('Ajax request successful', response);
  
                    // Sort tag options alphabetically
                    response.tag_options.sort();
  
                    // Update tag dropdown options based on the sorted response
                    var tagDropdown = $('#tag_dropdown');
                    tagDropdown.empty(); // Clear existing options
  
                    // Add new options based on the sorted response
                    for (var i = 0; i < response.tag_options.length; i++) {
                        var tagOption = response.tag_options[i];
                        tagDropdown.append('<option value="' + tagOption + '">' + tagOption + '</option>');
                    }
                },
                error: function (error) {
                    console.log('Error fetching tag options:', error);
                }
            });
        });
    });
    
  </script>
  
  <script>
    document.getElementById("fetchDataButton").addEventListener("click", function(event) {
    event.preventDefault(); // Prevent the form from submitting immediately
    
    if (confirm("Save To Database?")) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/save_to_oracle_manualpoll", true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

        xhr.onload = function() {
            if (xhr.status == 200) {
                var response = JSON.parse(xhr.responseText);
                alert(response.message); 
            } else {
                alert("Error: " + xhr.status);
            }
        };

        xhr.send(new FormData(document.getElementById("myForm")));
    }
});

  </script>
  
  <script>
document.getElementById('pingData').addEventListener('click', function(event) {
    event.preventDefault();  // Prevent the default form submission

    var loadingIndicator = document.getElementById('loading');
    loadingIndicator.style.display = 'block';  // Show the loading indicator

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/pingdata', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

    xhr.onload = function() {
        loadingIndicator.style.display = 'none';  // Hide the loading indicator
        
        if (xhr.status == 200) {
            var response = JSON.parse(xhr.responseText);
            var messages = response.map(function(res) {
                return res.message;
            }).join('\n');
            alert(messages);  // Display all ping results in an alert
        } else {
            alert("Error: " + xhr.status);
        }
    };

    xhr.onerror = function() {
        loadingIndicator.style.display = 'none';  // Ensure the indicator hides on error
        alert("Request failed");
    };

    xhr.send();  // Send the request to the server
});
</script>
  
  
  
  
  <script>
      // Function to show the loading bar
      function showLoadingBar() {
          document.getElementById('loading-bar').style.width = '100%';
      }
  
      // Function to hide the loading bar
      function hideLoadingBar() {
          document.getElementById('loading-bar').style.width = '0';
      }
  
      // Event listener for page load
      window.addEventListener('load', function () {
          hideLoadingBar(); // Hide the loading bar initially
      });
  
      // Event listener for beforeunload (when the page is about to be reloaded)
      window.addEventListener('beforeunload', function () {
          showLoadingBar(); // Show the loading bar before the page reloads
      });
  
  </script>
  <script>
      function checkInternetConnection() {
          // ตรวจสอบสถานะเชื่อมต่ออินเทอร์เน็ต
          // ตรวจสอบได้ว่ามีการเชื่อมต่อหรือไม่ โดยใช้ navigator.onLine
          return navigator.onLine;
      }
  
      // JavaScript
      function updateStatus() {
          var statusContainer = document.getElementById('status-container');
          var statusIcon = document.getElementById('status-icon');
          var statusText = document.getElementById('status-text');
          var lastUpdate = document.getElementById('last-update-time');
  
          var now = new Date();
          var timeString = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true });
  
          if (checkInternetConnection()) {
              // ถ้าเชื่อมต่ออินเทอร์เน็ต
              statusIcon.style.color = 'green'; // สีเขียว
              statusText.textContent = 'Online';
              statusText.classList.remove('offline'); // ลบ class 'offline' ถ้ามี
          } else {
              // ถ้าไม่เชื่อมต่ออินเทอร์เน็ต
              statusIcon.style.color = 'red'; // สีแดง
              statusText.textContent = 'Offline';
              statusText.classList.add('offline'); // เพิ่ม class 'offline'
          }
  
          lastUpdate.textContent = timeString;
      }
      // JavaScript
      setInterval(updateStatus, 10000); // อัปเดตทุก 1 วินาที (1000 มิลลิวินาที)
  
  </script>
  <script>
      // Function to update weather icon
      function updateWeatherIcon(weatherCondition) {
          var iconClass;
  
          // Add logic to determine the appropriate weather icon based on the condition
          switch (weatherCondition.toLowerCase()) {
              case 'clear':
                  iconClass = 'fas fa-sun'; // Font Awesome sun icon
                  break;
              case 'clouds':
                  iconClass = 'fas fa-cloud'; // Font Awesome cloud icon
                  break;
              case 'rain':
                  iconClass = 'fas fa-cloud-showers-heavy'; // Font Awesome rain icon
                  break;
              case 'thunderstorm':
                  iconClass = 'fas fa-bolt'; // Font Awesome thunderstorm icon
                  break;
              case 'snow':
                  iconClass = 'fas fa-snowflake'; // Font Awesome snow icon
                  break;
              default:
                  iconClass = 'fas fa-question-circle'; // Default to a question mark icon for unknown conditions
          }
  
          // Set the appropriate icon class
          document.getElementById('weather-icon').innerHTML = '<i class="' + iconClass + '"></i>';
      }
  
  </script>
  <script>
      // Function to update date and time
      function updateDateTime() {
          var now = new Date();
          var dateTimeString = now.toLocaleString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false });
          document.getElementById('date-time').textContent = dateTimeString;
      }
  
      // Function to update weather data from OpenWeatherMap API
      function updateWeatherData() {
          // Replace 'YOUR_API_KEY' with your actual OpenWeatherMap API key
          var apiKey = 'fbae867d03fc9892a7469d2f562ce558';
          var city = 'Bangkok'; // Replace with your city name
          var apiUrl = 'https://api.openweathermap.org/data/2.5/weather?q=' + city + '&appid=' + apiKey;
  
          fetch(apiUrl)
              .then(response => response.json())
              .then(data => {
                  // Extract relevant weather data
                  var weatherCondition = data.weather[0].main;
                  var weatherDescription = data.weather[0].description;
                  var temperatureKelvin = data.main.temp;
  
                  // Convert temperature from Kelvin to Celsius
                  var temperatureCelsius = temperatureKelvin - 273.15;
  
                  // Update weather icon, description, and temperature
                  updateWeatherIcon(weatherCondition);
                  document.getElementById('weather-description').textContent = 'Weather: ' + weatherDescription;
                  document.getElementById('temperature').textContent = 'Temperature: ' + temperatureCelsius.toFixed(2) + '°C';
              })
              .catch(error => console.error('Error fetching weather data:', error));
      }
  
  
      // Function to update weather icon
      function updateWeatherIcon(weatherCondition) {
          var iconClass;
  
          // Add logic to determine the appropriate weather icon based on the condition
          switch (weatherCondition.toLowerCase()) {
              case 'clear':
                  iconClass = 'fa-sun';
                  break;
              case 'clouds':
                  iconClass = 'fa-cloud';
                  break;
              case 'rain':
                  iconClass = 'fa-cloud-showers-heavy';
                  break;
              default:
                  iconClass = 'fa-question-circle'; // Default to a question mark icon for unknown conditions
          }
  
          // Set the appropriate icon class
          document.getElementById('weather-icon').innerHTML = '<i class="fa ' + iconClass + '" aria-hidden="true"></i>';
      }
  
      // Call the functions initially
      updateDateTime();
      updateWeatherData();
  
      // Update date and time every second
      setInterval(updateDateTime, 1000);
  
      // Update weather data every 10 minutes (adjust as needed)
      setInterval(updateWeatherData, 600000);
  </script>
  <script>
      $(".sidebar-dropdown > a").click(function () {
          $(".sidebar-submenu").slideUp(200);
          if (
              $(this)
                  .parent()
                  .hasClass("active")
          ) {
              $(".sidebar-dropdown").removeClass("active");
              $(this)
                  .parent()
                  .removeClass("active");
          } else {
              $(".sidebar-dropdown").removeClass("active");
              $(this)
                  .next(".sidebar-submenu")
                  .slideDown(200);
              $(this)
                  .parent()
                  .addClass("active");
          }
      });
  
      $("#close-sidebar").click(function () {
          $(".page-wrapper").removeClass("toggled");
      });
      $("#show-sidebar").click(function () {
          $(".page-wrapper").addClass("toggled");
      });
  
  
  
  </script>
  <script>

    function clearFilters() {
      document.getElementById('region_dropdown').value = '';
      document.getElementById('tag_dropdown').value = '';
      document.getElementById('date_picker').value = '';
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'block';
      }
    }
  
    document.addEventListener('DOMContentLoaded', function () {
      // Assuming you have JavaScript/jQuery to handle changes and update the display
      var selectedRegion = null;
      var selectedTag = null;
      var selectedDate = null;
  
      document.getElementById('region_dropdown').addEventListener('change', function () {
        selectedRegion = this.value;
      });
  
      document.getElementById('tag_dropdown').addEventListener('change', function () {
        selectedTag = this.value;
      });
  
      document.getElementById('date_picker').addEventListener('change', function () {
        selectedDate = this.value;
      });
  
      // Event listener for form submission with 'daily_data' event
      var formDailyData = document.querySelector('form[action="/billing_data"]'); // Adjust this selector based on your actual form
      formDailyData.addEventListener('config_data', function (event) {
        event.preventDefault(); // Prevent the form from submitting immediately
  
        showLoadingOverlay();
  
        // Simulate delay with setTimeout (you can replace this with your actual loading logic)
        setTimeout(function () {
          // Update the displayed values after the loading is complete
          document.getElementById('selected_region').innerText = selectedRegion;
          document.getElementById('selected_tag').innerText = selectedTag;
          document.getElementById('selected_date').innerText = selectedDate;
  
          // Optionally, update the meter ID
          var selectedMeterIdSpan = document.getElementById('selected_meter_id');
          if (selectedMeterIdSpan) {
            selectedMeterIdSpan.innerText = "{{ selected_meter_id }}"; // Replace with your actual meter ID variable
          }
  
          // Reset selected values
          selectedRegion = null;
          selectedTag = null;
          selectedDate = null;
  
          // Submit the form programmatically
          formDailyData.submit();
        }, 2000); // Adjust the delay time as needed (in milliseconds)
      });
  
      // Event listener for form submission with 'config_data' event
      var formConfigData = document.querySelector('form[action="/billing_data"]'); // Adjust this selector based on your actual form
      formConfigData.addEventListener('daily_data', function (event) {
        event.preventDefault(); // Prevent the form from submitting immediately
  
        showLoadingOverlay();
  
        // Simulate delay with setTimeout (you can replace this with your actual loading logic)
        setTimeout(function () {
          // Update the displayed values after the loading is complete
          document.getElementById('selected_region').innerText = selectedRegion;
          document.getElementById('selected_tag').innerText = selectedTag;
          document.getElementById('selected_date').innerText = selectedDate;
  
          // Optionally, update the meter ID
          var selectedMeterIdSpan = document.getElementById('selected_meter_id');
          if (selectedMeterIdSpan) {
            selectedMeterIdSpan.innerText = "{{ selected_meter_id }}"; // Replace with your actual meter ID variable
          }
  
          // Reset selected values
          selectedRegion = null;
          selectedTag = null;
          selectedDate = null;
  
          // Submit the form programmatically
          formConfigData.submit();
        }, 2000); // Adjust the delay time as needed (in milliseconds)
      });
    });
    function showLoading() {
      // แสดง loading overlay
      document.getElementById('loadingOverlay').style.display = 'block';
    }
  
    // ฟังก์ชันนี้ควรถูกเรียกเมื่อข้อมูลถูกโหลดแล้ว
    function hideLoading() {
      // ซ่อน loading overlay
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  
  
    // Wait for the document to be ready
    // Wait for the document to be ready
  
  
  
  
      // Event listener for region dropdown change
      $('#region_dropdown').change(function () {
        var selectedRegion = $(this).val();
  
        $.ajax({
          type: 'GET',
          url: '/get_tags',
          data: { 'selected_region': selectedRegion },
          success: function (response) {
            // Clear existing options in the tag dropdown
            $('#tag_dropdown').empty();
  
            // Add the 'All' option
            $('#tag_dropdown').append('<option value="" selected>All</option>');
  
            // Add new tag options based on the response
            for (var i = 0; i < response.tag_options.length; i++) {
              var tag = response.tag_options[i];
  
              // Check if the tag is the first one in the list, and set it as selected
              var isSelected = i === 0 ? 'selected' : '';
  
              $('#tag_dropdown').append('<option value="' + tag + '" ' + isSelected + '>' + tag + '</option>');
            }
            hideLoadingOverlay(); // Hide loading overlay after successful AJAX request
          },
          error: function (error) {
            console.log('Error fetching tag options:', error);
            hideLoadingOverlay(); // Hide loading overlay after AJAX request error
          }
        });
      });
  
  
  </script>
  
<script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/jquery-easing/jquery.easing.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>
</html>
